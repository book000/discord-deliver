# Claude Code 作業方針

## 目的

このファイルは、Claude Code がこのプロジェクトで作業を行う際の方針とルールを定義します。

## 判断記録のルール

判断を行う際は、以下の内容を必ず記録すること：

1. **判断内容の要約**: 何を決定したか
2. **検討した代替案**: 他にどのような選択肢があったか
3. **採用しなかった案とその理由**: なぜその案を選ばなかったか
4. **前提条件・仮定・不確実性**: どのような前提に基づいているか、何が不確実か
5. **他エージェントによるレビュー可否**: 他のエージェントにレビューを依頼すべきか

**重要**: 前提・仮定・不確実性を明示すること。仮定を事実のように扱ってはならない。

## プロジェクト概要

- **目的**: Discord にメッセージを送信する軽量な Web サーバーブリッジ
- **主な機能**:
  - HTTP POST リクエストで JSON ペイロードを受け取る
  - Discord Bot API を使用して Discord チャンネルにメッセージを送信
  - プレーンテキストメッセージと埋め込みメッセージの両方をサポート
  - チャンネル ID は環境変数または URL パスで指定可能
  - Docker コンテナで動作する軽量サーバー

## 重要ルール

- **会話言語**: 日本語
- **コード内コメント**: 日本語
- **エラーメッセージ**: 英語
- **コミットメッセージ**: [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) に従う
  - 形式: `<type>(<scope>): <description>`
  - `<description>` は日本語で記載
  - 例: `feat: チャンネル ID の検証機能を追加`
- **日本語と英数字の間**: 半角スペースを挿入

## 環境のルール

- **ブランチ命名**: [Conventional Branch](https://conventional-branch.github.io) に従う
  - 形式: `<type>/<description>`
  - `<type>` は短縮形（feat, fix）を使用
  - 例: `feat/add-validation`, `fix/error-handling`
- **GitHub リポジトリ調査**: テンポラリディレクトリに git clone してコード検索
- **Renovate PR の扱い**: Renovate が作成した既存の PR に対して、追加コミットや更新を行ってはならない

## コード改修時のルール

- **日本語と英数字の間**: 半角スペースを挿入する
- **既存のエラーメッセージで絵文字がある場合**: 全体で統一された絵文字を使用する
- **関数やインターフェースには docstring を記載**: 日本語で記載し、既存コードを変更した場合は更新する

## 相談ルール

以下の観点で他エージェントに相談することができる：

- **Codex CLI (`/ask-codex`)**:
  - 実装コードに対するソースコードレビュー
  - 関数設計、モジュール内部の実装方針などの局所的な技術判断
  - アーキテクチャ、モジュール間契約、パフォーマンス/セキュリティといった全体影響の判断
  - 実装の正当性確認、機械的ミスの検出、既存コードとの整合性確認

- **Gemini CLI (`/ask-gemini`)**:
  - SaaS 仕様、言語・ランタイムのバージョン差、料金・制限・クォータといった、最新の適切な情報が必要な外部依存の判断
  - 外部一次情報の確認、最新仕様の調査、外部前提条件の検証

**他エージェントが指摘・異議を提示した場合の対応**（黙殺・無言での不採用は禁止）:

1. 指摘を受け入れ、判断を修正する
2. 指摘を退け、その理由を明示する

**必ず実施すること**:

- 他エージェントの提案を鵜呑みにせず、その根拠や理由を理解する
- 自身の分析結果と他エージェントの意見が異なる場合は、双方の視点を比較検討する
- 最終的な判断は、両者の意見を総合的に評価した上で、自身で下す

## 開発コマンド

このプロジェクトには `package.json` は存在せず、PHP プロジェクトとして Docker で動作します。

```bash
# Docker イメージをビルド
docker build src/ -t discord-deliver

# docker-compose で起動（本番環境）
docker-compose up

# サンプル・テストを実行
cd example && docker-compose up

# シェルスクリプトの Lint
shellcheck src/entrypoint.sh

# GitHub Actions と同等の Docker ビルド検証
cd src && docker build . --file Dockerfile
```

## アーキテクチャと主要ファイル

### アーキテクチャサマリー

- **src/main.php**: コア Web サーバーロジック（小規模なファイル）
  - PHP built-in server で HTTP リクエストを処理
  - Discord Bot API への POST リクエストを実行
- **src/Dockerfile**: PHP 8 Alpine コンテナ定義
  - ポート 80 を公開
- **src/entrypoint.sh**: コンテナ起動スクリプト
  - PHP built-in server を 0.0.0.0:80 で起動
- **example/**: 使用例とテストクライアント
  - curl で Discord にメッセージを送信するサンプル
- **.github/workflows/**: CI/CD パイプライン
  - `docker-image.yml`: Docker イメージビルド検証
  - `shell-ci.yml`: ShellCheck による Lint
  - `docker-publish.yml`: リリース時の Docker Hub 公開

### 主要ディレクトリ

```
discord-deliver/
├── .github/workflows/  # CI/CD 設定
├── src/               # メインアプリケーション
├── example/           # 使用例・テスト
├── docker-compose.yml # 本番環境設定
└── renovate.json     # 依存関係更新設定
```

## 実装パターン

### 推奨パターン

- PHP の標準機能を使用（外部依存なし）
- エラーハンドリングを適切に行い、HTTP ステータスコードを返す
- 環境変数で設定を管理
- Docker コンテナで動作することを前提とする

### 非推奨パターン

- 外部ライブラリへの依存追加（このプロジェクトは依存ゼロを維持）
- 複雑な機能追加（軽量性を維持）

## テスト

### テスト方針

- **GitHub Actions CI**: すべての push と PR で Docker イメージビルドを検証
- **ShellCheck**: `.sh` ファイルの Lint（SC2086, SC2001 を除外）
- **統合テスト**: `example/` ディレクトリで実際の動作確認

### 追加テスト条件

- 新機能追加時は `example/` に使用例を追加
- Docker イメージのビルドが成功することを確認
- 環境変数の変更時は `docker-compose.yml` と `example/docker-compose.yml` を更新

## ドキュメント更新ルール

### 更新対象

- `README.md`: 機能追加や仕様変更時
- `.github/workflows/*.yml`: CI/CD の変更時
- `docker-compose.yml`: コンテナ構成の変更時
- `example/`: 新機能の使用例追加時

### 更新タイミング

- 機能追加や仕様変更の実装と同時にドキュメントを更新
- API エンドポイントや環境変数の変更時は必ず `README.md` を更新

## 作業チェックリスト

### 新規改修時

新規改修を行う前に、以下を必ず確認すること：

1. プロジェクトについて詳細に探索し理解すること
2. 作業を行うブランチが適切であること。すでに PR を提出しクローズされたブランチでないこと
3. 最新のリモートブランチに基づいた新規ブランチであること
4. PR がクローズされ、不要となったブランチは削除されていること
5. ~~プロジェクトで指定されたパッケージマネージャにより、依存パッケージをインストールしたこと~~（このプロジェクトには依存パッケージなし）

### コミット・プッシュ前

コミット・プッシュする前に、以下を必ず確認すること：

1. コミットメッセージが [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) に従っていること。`<description>` は日本語で記載
2. コミット内容にセンシティブな情報が含まれていないこと
3. ~~Lint / Format エラーが発生しないこと~~（PHP ファイルの場合は構文エラーがないこと、`.sh` ファイルの場合は ShellCheck を実行）
4. Docker イメージのビルドが成功すること

### プルリクエストを作成する前

プルリクエストを作成する前に、以下を必ず確認すること：

1. プルリクエストの作成をユーザーから依頼されていること
2. コミット内容にセンシティブな情報が含まれていないこと
3. コンフリクトする恐れがないこと

### プルリクエストを作成した後

プルリクエストを作成した後は、以下を必ず実施すること。PR 作成後のプッシュ時に毎回実施：

1. コンフリクトが発生していないこと
2. PR 本文の内容は、ブランチの現在の状態を、今までのこの PR での更新履歴を含むことなく、最新の状態のみ、漏れなく日本語で記載されていること。この PR を見たユーザーが、最終的にどのような変更を含む PR なのかをわかりやすく、細かく記載されていること
3. `gh pr checks <PR ID> --watch` で GitHub Actions CI を待ち、その結果がエラーとなっていないこと。成功している場合でも、ログを確認し、誤って成功扱いになっていないこと
4. `request-review-copilot` コマンドが存在する場合、`request-review-copilot https://github.com/$OWNER/$REPO/pull/$PR_NUMBER` で GitHub Copilot へレビューを依頼すること
5. 10 分以内に投稿される GitHub Copilot レビューへの対応を行うこと。対応したら、レビューコメントそれぞれに対して返信を行うこと
6. `/code-review:code-review` によるコードレビューを実施したこと。コードレビュー内容に対しては、**スコアが 50 以上の指摘事項**に対して対応する

## リポジトリ固有

- このプロジェクトは Docker Hub に公開されている (`book000/discord-deliver`)
- マルチプラットフォームビルド (linux/amd64, linux/arm64) に対応
- Renovate により依存関係が自動更新される
- **必須環境変数**:
  - `DISCORD_TOKEN`: Discord Bot の認証トークン
  - `DISCORD_CHANNEL_ID`: デフォルトのチャンネル ID（オプション）
- **API エンドポイント**:
  - `POST /`: 環境変数 `DISCORD_CHANNEL_ID` を使用
  - `POST /{channel_id}`: URL で指定したチャンネル ID を使用
- **リクエストボディ形式**:
  - `content`: プレーンテキストメッセージ
  - `embed`: 埋め込みメッセージオブジェクト
- **エラーレスポンス**:
  - 400: リクエストボディが存在しない場合
  - 404: チャンネル ID が不正または未指定の場合
  - 405: POST 以外のメソッド
  - 415: `Content-Type` が `application/json` でない場合
  - 500: `DISCORD_TOKEN` が未設定の場合
